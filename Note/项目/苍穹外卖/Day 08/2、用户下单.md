### 需求分析与设计

![[Pasted image 20240523211615.png]]

![[Pasted image 20240523211724.png]]

![[Pasted image 20240523214302.png]]

![[Pasted image 20240523214413.png|475]]

![[Pasted image 20240523214549.png]]

![[Pasted image 20240523215544.png]]

![[Pasted image 20240523215617.png]]

### 代码开发

OrderController：

```java
@RestController("userOrderController")  
@Slf4j  
@Api(tags = "用户端订单相关接口")  
@RequestMapping("/user/order")  
public class OrderController {  
  
    @Autowired  
    private OrderService orderService;  
  
    @PostMapping("/submit")  
    @ApiOperation("用户下单")  
    public Result<OrderSubmitVO> submit(@RequestBody OrdersSubmitDTO ordersSubmitDTO) {  
        log.info("用户下单，参数为:{}", ordersSubmitDTO);  
        OrderSubmitVO orderSubmitVO = orderService.submit(ordersSubmitDTO);  
        return Result.success(orderSubmitVO);  
    }  
}
```

OrderService：

```java
public interface OrderService {  
  
    /**  
     * 用户下单  
     * @param ordersSubmitDTO  
     * @return  
     */  
    OrderSubmitVO submit(OrdersSubmitDTO ordersSubmitDTO);  
}
```

OrderServiceImpl：

```java
@Service  
public class OrderServiceImpl implements OrderService {  
  
    @Autowired  
    private OrderMapper orderMapper;  
    @Autowired  
    private OrderDetailMapper orderDetailMapper;  
    @Autowired  
    private AddressBookMapper addressBookMapper;  
    @Autowired  
    private ShoppingCartMapper shoppingCartMapper;  
  
    @Override  
    @Transactional
    public OrderSubmitVO submit(OrdersSubmitDTO ordersSubmitDTO) {  
  
        // 1、处理各种业务异常（地址簿为空，购物车数据为空）  
        AddressBook addressBook = addressBookMapper.getById(ordersSubmitDTO.getAddressBookId());  
        if(addressBook == null) {  
            throw new AddressBookBusinessException(MessageConstant.ADDRESS_BOOK_IS_NULL);  
        }  
        Long currentId = BaseContext.getCurrentId();  
        ShoppingCart shoppingCart = new ShoppingCart();  
        shoppingCart.setUserId(currentId);  
        List<ShoppingCart> shoppingCartList = shoppingCartMapper.list(shoppingCart);  
        if(shoppingCartList == null || shoppingCartList.isEmpty()){  
            throw new ShoppingCartBusinessException(MessageConstant.SHOPPING_CART_IS_NULL);  
        }  
  
        // 2、向订单表插入1条数据  
        Orders orders = new Orders();  
        BeanUtils.copyProperties(ordersSubmitDTO, orders);  
        orders.setOrderTime(LocalDateTime.now());  
        orders.setPayStatus(Orders.UN_PAID);  
        orders.setStatus(Orders.PENDING_PAYMENT);  
        orders.setNumber(String.valueOf(System.currentTimeMillis()));  
        orders.setPhone(addressBook.getPhone());  
        orders.setConsignee(addressBook.getConsignee());  
        orders.setAddress(addressBook.getDetail());  
        orders.setUserId(currentId);  
        orderMapper.insert(orders);  
  
        Long orderId = orders.getId(); //获取当前订单id  
        List<OrderDetail> orderDetailList = new ArrayList<>();  
        // 3、向订单明细表插入n条数据  
        OrderDetail orderDetail = new OrderDetail();  
        BeanUtils.copyProperties(orders, orderDetail);  
        for(ShoppingCart cart : shoppingCartList) {  
            BeanUtils.copyProperties(cart, orderDetail);  
            orderDetail.setOrderId(orderId); //设置当前订单明细关联的订单id  
            orderDetailList.add(orderDetail);  
        }  
        orderDetailMapper.insertBatch(orderDetailList);  
  
        // 4、清空当前用户的购物车数据  
        shoppingCartMapper.deleteByUserId(currentId);  
  
        // 5、封装到VO返回结束  
        OrderSubmitVO orderSubmitVO = OrderSubmitVO.builder()  
                .id(orderId)  
                .orderTime(orders.getOrderTime())  
                .orderNumber(orders.getNumber())  
                .orderAmount(orders.getAmount())  
                .build();  
        return orderSubmitVO;  
    }  
}
```

OrderMapper：

```java
@Mapper  
public interface OrderMapper {  
    /**  
     * 插入订单数据  
     * @param orders  
     */  
    void insert(Orders orders);  
}
```

```xml
<mapper namespace="com.sky.mapper.OrderMapper">  
    <!--    useGeneratedKeys="true" keyProperty="id"用于获取主键值id-->  
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">  
        insert into orders (number, status, user_id, address_book_id, order_time, checkout_time, pay_method, pay_status, amount, remark, phone, address, user_name, consignee, cancel_reason, rejection_reason, cancel_time, estimated_delivery_time, delivery_status, delivery_time, pack_amount, tableware_number, tableware_status)        values (#{number}, #{status}, #{userId}, #{addressBookId}, #{orderTime}, #{checkoutTime}, #{payMethod}, #{payStatus}, #{amount}, #{remark}, #{phone}, #{address}, #{userName}, #{consignee}, #{cancelReason}, #{rejectionReason}, #{cancelTime}, #{estimatedDeliveryTime}, #{deliveryStatus}, #{deliveryTime}, #{packAmount}, #{tablewareNumber}, #{tablewareStatus})    
    </insert>  
</mapper>
```

OrderDetailMapper：

```java
@Mapper  
public interface OrderDetailMapper {  
    /**  
     * 批量插入订单明细  
     * @param orderDetailList  
     */  
    void insertBatch(List<OrderDetail> orderDetailList);  
}
```

```java
<mapper namespace="com.sky.mapper.OrderDetailMapper">  
    <insert id="insertBatch">  
        insert into order_detail (name, image, order_id, dish_id, setmeal_id, dish_flavor, number, amount) VALUES  
            <foreach collection="orderDetailList" separator="," item="od">  
                (#{od.name},#{od.image},#{od.orderId},#{od.dishId},#{od.setmealId},#{od.dishFlavor},#{od.number},#{od.amount})  
            </foreach>  
    </insert>  
</mapper>
```

### 注意事项

1、出现了个问题，前端传的DTO对象为空，没有收到，一查才发现是`@RequestBody`的包给导错了。。。

![[Pasted image 20240528000813.png]]

2.在 MyBatis 的 `foreach` 标签中，`open` 和 `close` 属性用于在整个迭代生成的内容之前和之后添加特定的字符串。这在某些情况下非常有用，例如构建一个包含多个条件的 SQL 查询时。但在**批量插入的情况下，它们通常是不需要的**。 

如果这样写：

```xml
<insert id="insertBatch">  
    insert into order_detail (name, image, order_id, dish_id, setmeal_id, dish_flavor, number, amount) VALUES  
        <foreach collection="orderDetailList" separator="," item="od" open="(" close=")">  
            (#{od.name},#{od.image},#{od.orderId},#{od.dishId},#{od.setmealId},#{od.dishFlavor},#{od.number},#{od.amount})  
        </foreach>  
</insert>
```

结果是：

```java
insert into order_detail (name, image, order_id, dish_id, setmeal_id, dish_flavor, number, amount) VALUES ((value1, value2, ...), (value3, value4, ...), ...)
```

这会导致 SQL 语法错误！

3、属性拷贝时`BeanUtils.copyProperties(orders, orderDetail);`但 orders 和 orderDetail 都有id属性，但此时不用担心id会乱：

如果你的数据库表的 `id` 列配置为自增，那么即使你在将 `orderDetail` 对象插入数据库之前通过属性拷贝赋值了一个 `id` 值，数据库也会忽略你手动设置的 `id`，并自动生成一个新的唯一 `id`。

4、由于同时对两张数据库表进行操作，一定要加上**事务注解**！

5、之前把`OrderDetail orderDetail = new OrderDetail();`放到for循环外了，导致所有的orderDetail都是一样的......一定要放在for循环里面，毕竟是每一次都是新的对象。

```java
Long orderId = orders.getId(); //获取当前订单id  
List<OrderDetail> orderDetailList = new ArrayList<>();  
// 3、向订单明细表插入n条数据  
for(ShoppingCart cart : shoppingCartList) {  
    OrderDetail orderDetail = new OrderDetail(); //要放在for循环里面  
    BeanUtils.copyProperties(cart, orderDetail);  
    orderDetail.setOrderId(orderId); //设置当前订单明细关联的订单id  
    orderDetailList.add(orderDetail);  
}  
orderDetailMapper.insertBatch(orderDetailList);
```

### 测试

没问题。

![[Pasted image 20240528094924.png|276]]

![[Pasted image 20240528111139.png]]

![[Pasted image 20240528111129.png]]