### 需求分析与设计

![[Pasted image 20240531145628.png]]

![[Pasted image 20240531145647.png]]

### 代码开发

新建一个websocket包，再新建一个WebSocketServer类：
  
```java
/**  
 * WebSocket服务  
 */  
@Component  
@ServerEndpoint("/ws/{sid}")  
public class WebSocketServer {  
  
    //存放会话对象  
    private static Map<String, Session> sessionMap = new HashMap();  
  
    /**  
     * 连接建立成功调用的方法  
     */  
    @OnOpen  
    public void onOpen(Session session, @PathParam("sid") String sid) {  
        System.out.println("客户端：" + sid + "建立连接");  
        sessionMap.put(sid, session);  
    }  
  
    /**  
     * 收到客户端消息后调用的方法  
     *  
     * @param message 客户端发送过来的消息  
     */  
    @OnMessage  
    public void onMessage(String message, @PathParam("sid") String sid) {  
        System.out.println("收到来自客户端：" + sid + "的信息:" + message);  
    }  
  
    /**  
     * 连接关闭调用的方法  
     *  
     * @param sid  
     */  
    @OnClose  
    public void onClose(@PathParam("sid") String sid) {  
        System.out.println("连接断开:" + sid);  
        sessionMap.remove(sid);  
    }  
  
    /**  
     * 群发  
     *  
     * @param message  
     */  
    public void sendToAllClient(String message) {  
        Collection<Session> sessions = sessionMap.values();  
        for (Session session : sessions) {  
            try {  
                //服务器向客户端发送消息  
                session.getBasicRemote().sendText(message);  
            } catch (Exception e) {  
                e.printStackTrace();  
            }  
        }  
    }  
}
```

再编写一个WebSocketConfiguration配置类：

```java
/**  
 * WebSocket配置类，用于注册WebSocket的Bean  
 */@Configuration  
public class WebSocketConfiguration {  
  
    @Bean  
    public ServerEndpointExporter serverEndpointExporter() {  
        return new ServerEndpointExporter();  
    }  
}
```

在OrderServiceImpl中加入来单提醒代码，注意这里是在payment方法中：

```java
/**  
     * 订单支付  
     * @param ordersPaymentDTO  
     * @return  
     */  
    public OrderPaymentVO payment(OrdersPaymentDTO ordersPaymentDTO) throws Exception {  
        // 当前登录用户id  
        Long userId = BaseContext.getCurrentId();  
        User user = userMapper.getById(userId);  
        Orders orders = orderMapper.getByNumber(ordersPaymentDTO.getOrderNumber());  
  
        JSONObject jsonObject = new JSONObject();  
        jsonObject.put("code", "ORDERPAID");  
        OrderPaymentVO vo = jsonObject.toJavaObject(OrderPaymentVO.class);  
        vo.setPackageStr(jsonObject.getString("package"));  
        Integer OrderPaidStatus = Orders.PAID;//支付状态，已支付  
        Integer OrderStatus = Orders.TO_BE_CONFIRMED;  //订单状态，待接单  
        LocalDateTime check_out_time = LocalDateTime.now();//更新支付时间  
        orderMapper.updateStatus(OrderStatus, OrderPaidStatus, check_out_time, orders.getId());  
  
        // 通过websocket向客户端浏览器推送消息  
        Map map = new HashMap();  
        map.put("type",1); // 1表示来单提醒，2表示客户催单  
        map.put("orderId",orders.getId());  
        map.put("content","订单号"+ ordersPaymentDTO.getOrderNumber());  
  
        String json = JSON.toJSONString(map);  
        webSocketServer.sendToAllClient(json);  
        return vo;  
    }
```

### 测试

![[Pasted image 20240531152708.png|450]]