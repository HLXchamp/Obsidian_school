### 需求分析与设计

![[Pasted image 20240601155741.png]]

![[Pasted image 20240601155804.png]]
### 代码开发

![[Pasted image 20240601163603.png]]

ReportController：

```java
@GetMapping("/ordersStatistics")  
@ApiOperation("订单统计")  
public Result<OrderReportVO> ordersStatistics(  
        @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate begin,  
        @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate end){  
    log.info("订单数据统计：begin:{},end:{}", begin, end);  
    return Result.success(reportService.getOrdersStatistics(begin,end));  
}
```

ReportService：

```java
/**  
 * 统计指定时间内的订单数据  
 * @param begin  
 * @param end  
 * @return  
 */  
OrderReportVO getOrdersStatistics(LocalDate begin, LocalDate end);
```

```java
@Override  
public OrderReportVO getOrdersStatistics(LocalDate begin, LocalDate end) {  
    //当前集合用于存放从begin到end范围内的每天的日期  
    List<LocalDate> dateList = new ArrayList<>();  
  
    dateList.add(begin);  
  
    while (!begin.equals(end)) {  
        begin = begin.plusDays(1);  
        dateList.add(begin);  
    }  
  
    //存放每天的订单总数  
    List<Integer> orderCountList = new ArrayList<>();  
    //存放每天的有效订单数  
    List<Integer> validOrderCountList = new ArrayList<>();  
  
    for (LocalDate date : dateList) {  
  
        LocalDateTime beginTime = LocalDateTime.of(date, LocalTime.MIN);  
        LocalDateTime endTime = LocalDateTime.of(date, LocalTime.MAX);  
  
        Integer count1 = getOrderCount(beginTime, endTime, null);  
        Integer orderCount = count1 == null ? 0 : count1;  
  
        Integer count2 = getOrderCount(beginTime, endTime, Orders.COMPLETED);  
        Integer validOrderCount = count2 == null ? 0 : count2;  
  
        orderCountList.add(orderCount);  
        validOrderCountList.add(validOrderCount);  
    }  
  
    //计算时间区间内的订单总数量  
    Integer totalOrderCount = orderCountList.stream().reduce(Integer::sum).get();  
  
    //计算时间区间内的有效订单数量  
    Integer validOrderCount = validOrderCountList.stream().reduce(Integer::sum).get();  
  
    Double orderCompletionRate = 0.0;  
    if(totalOrderCount != 0){  
        //计算订单完成率  
        orderCompletionRate = validOrderCount.doubleValue() / totalOrderCount;  
    }  
    //计算区间内的有效订单数量  
  
    //封装返回结果  
    return OrderReportVO.builder()  
            .dateList(StringUtils.join(dateList,","))  
            .orderCountList(StringUtils.join(orderCountList,","))  
            .validOrderCountList(StringUtils.join(validOrderCountList,","))  
            .totalOrderCount(totalOrderCount)  
            .validOrderCount(validOrderCount)  
            .orderCompletionRate(orderCompletionRate)  
            .build();  
}  
  
private Integer getOrderCount(LocalDateTime begin, LocalDateTime end, Integer status){  
    Map map = new HashMap();  
    map.put("begin", begin);  
    map.put("end", end);  
    map.put("status", status);  
  
    return orderMapper.countByMap(map);  
}
```

OrderMapper：

```java
/**  
 * 根据动态条件统计用户数量  
 * @param map  
 * @return  
 */  
Integer countByMap(Map map);
```

```xml
<select id="countByMap" resultType="java.lang.Integer">  
    select count(id) from user  
    <where>  
        <if test="begin != null"> and create_time &gt; #{begin} </if>  
        <if test="end != null"> and create_time &lt; #{end} </if>  
    </where>  
</select>
```

### 测试

![[Pasted image 20240601162903.png|650]]