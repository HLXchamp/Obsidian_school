### 需求分析与设计

![[Pasted image 20240531161624.png]]

![[Pasted image 20240531161930.png]]

### 代码开发

![[Pasted image 20240531162010.png]]

 在管理端新建一个ReportController类：

```java
@RestController  
@Api(tags = "数据统计相关接口")  
@Slf4j  
@RequestMapping("/admin/report")  
public class ReportController {  
  
    @Autowired  
    private ReportService reportService;  
  
    @GetMapping("/turnoverStatistics")  
    public Result<TurnoverReportVO> turnoverStatistics(  
            @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate begin,  
            @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate end){  
        log.info("营业额数据统计：begin:{},end:{}", begin, end);  
        return Result.success(reportService.getTurnoverStatistics(begin,end));  
    }  
}
```

ReportService：

```java
/**  
 * 统计指定时间内的营业额  
 * @param begin  
 * @param end  
 * @return  
 */  
TurnoverReportVO getTurnoverStatistics(LocalDate begin, LocalDate end);
```

```java
@Service  
@Slf4j  
public class ReportServiceImpl implements ReportService {  
  
    @Autowired  
    private OrderMapper orderMapper;  
  
    @Override  
    public TurnoverReportVO getTurnoverStatistics(LocalDate begin, LocalDate end) {  
        //当前集合用于存放从begin到end范围内的每天的日期  
        List<LocalDate> dateList = new ArrayList<>();  
  
        dateList.add(begin);  
  
        while (!begin.equals(end)) {  
            //日期计算，计算指定日期的后一天对应的日期  
            begin = begin.plusDays(1);  
            dateList.add(begin);  
        }  
  
        //存放每天的营业额  
        List<Double> turnoverList = new ArrayList<>();  
        for (LocalDate date : dateList) {  
            //查询date日期对应的营业额数据，营业额是指：状态为“已完成”的订单金额合计  
            LocalDateTime beginTime = LocalDateTime.of(date, LocalTime.MIN);  
            LocalDateTime endTime = LocalDateTime.of(date, LocalTime.MAX);  
  
            // select sum(amount) from orders where order_time > beginTime and order_time < endTime and status = 5  
            Map map = new HashMap();  
            map.put("begin", beginTime);  
            map.put("end", endTime);  
            map.put("status", Orders.COMPLETED);  
            Double turnover = orderMapper.sumByMap(map);  
            turnover = turnover == null ? 0.0 : turnover;  
            turnoverList.add(turnover);  
        }  
  
        //封装返回结果  
        return TurnoverReportVO  
                .builder()  
                .dateList(StringUtils.join(dateList, ","))  
                .turnoverList(StringUtils.join(turnoverList, ","))  
                .build();  
    }  
}
```

OrderMapper：

```java
/**  
 * 根据动态条件统计营业额数据  
 * @param map  
 * @return  
 */  
Double sumByMap(Map map);
```

```xml
<select id="sumByMap" resultType="java.lang.Double">  
    select sum(amount) from orders  
    <where>  
        <if test="begin != null"> and order_time &gt; #{begin} </if>  
        <if test="end != null"> and order_time &lt; #{end} </if>  
        <if test="status != null"> and status = #{status} </if>  
    </where>  
</select>
```

### 测试

![[Pasted image 20240601150859.png|525]]