### 需求分析与设计

![[Pasted image 20240601151105.png]]

![[Pasted image 20240601151126.png]]

### 代码开发

![[Pasted image 20240601151423.png]]

ReportController：


```java
@GetMapping("/userStatistics")  
@ApiOperation("用户统计")  
public Result<UserReportVO> userStatistics(  
        @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate begin,  
        @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate end){  
    log.info("用户数据统计：begin:{},end:{}", begin, end);  
    return Result.success(reportService.getUserStatistics(begin,end));  
}
```

ReportService：

```java
/**  
 * 统计指定时间内的用户数据  
 * @param begin  
 * @param end  
 * @return  
 */  
UserReportVO getUserStatistics(LocalDate begin, LocalDate end);
```

```java
@Override  
public UserReportVO getUserStatistics(LocalDate begin, LocalDate end) {  
    //当前集合用于存放从begin到end范围内的每天的日期  
    List<LocalDate> dateList = new ArrayList<>();  
  
    dateList.add(begin);  
  
    while (!begin.equals(end)) {  
        //日期计算，计算指定日期的后一天对应的日期  
        begin = begin.plusDays(1);  
        dateList.add(begin);  
    }  
  
    //存放每天的新增用户数据  
    List<Integer> newUserList = new ArrayList<>();  
    //存放每天的总用户数量  
    List<Integer> totalUserList = new ArrayList<>();  
  
    for (LocalDate date : dateList) {  
        //查询date日期对应的用户数量  
        LocalDateTime beginTime = LocalDateTime.of(date, LocalTime.MIN);  
        LocalDateTime endTime = LocalDateTime.of(date, LocalTime.MAX);  
  
        Map map = new HashMap();  
        map.put("end", endTime);  
        // 总用户数量  
        Integer totalUser = userMapper.countByMap(map);  
  
        map.put("begin", beginTime);  
        Integer newUser = userMapper.countByMap(map);  
  
        totalUserList.add(totalUser);  
        newUserList.add(newUser);  
    }  
  
    //封装返回结果  
    return UserReportVO  
            .builder()  
            .dateList(StringUtils.join(dateList, ","))  
            .totalUserList(StringUtils.join(totalUserList, ","))  
            .newUserList(StringUtils.join(newUserList, ","))  
            .build();  
}
```

UserMapper：

```Java
/**  
 * 根据动态条件统计用户数量  
 * @param map  
 * @return  
 */  
Integer countByMap(Map map);
```

```xml
<select id="countByMap" resultType="java.lang.Integer">  
    select count(id) from user  
    <where>  
        <if test="begin != null"> and create_time &gt; #{begin} </if>  
        <if test="end != null"> and create_time &lt; #{end} </if>  
    </where>  
</select>
```
### 测试

![[Pasted image 20240601155313.png]]