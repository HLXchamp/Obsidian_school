### 需求分析与设计

#### 业务规则

- 分页查询历史订单
- 可以根据订单状态查询
- 展示订单数据时，需要展示的数据包括：下单时间、订单状态、订单金额、订单明细（商品名称、图片）
#### 接口设计

![[Pasted image 20240529092718.png|247]]
![[Pasted image 20240529092813.png|511]]

#### 易错点

- `&gt;`：大于符号 (`>`)，即 `greater than`。
- `&lt;`：小于符号 (`<`)，即 `less than`。

PageHelper 进行分页查询时，可以使用其他类型来接收分页结果，但`Page` 对象类型提供了更多的分页信息，如**总记录数、总页数**等，这些信息在处理分页逻辑时非常有用。

一定要看什么时候用什么对象，有些要用DTO，有些要用VO！

Mapper里的查询是动态查询，虽然目前只需要查询购物车数据，并不需要所有这些条件，但这些条件的存在可以为将来的扩展和不同查询需求做准备。

### 代码开发

OrderController：

```java
/**  
 * 历史订单查询  
 * @param page  
 * @param pageSize  
 * @return  
 */  
@GetMapping("/historyOrders")  
@ApiOperation("历史订单")  
public Result<PageResult> historyPage(@RequestParam(defaultValue = "1") Integer page,  
                                      @RequestParam(defaultValue = "10") Integer pageSize, Integer status) {  
    log.info("当前页数：{}，数量：{}", page, pageSize);  
    PageResult pageResult = orderService.page(page, pageSize, status);  
    return Result.success(pageResult);  
}
```

OrderService：

```java
/**  
 * 分页查询历史订单  
 * @param page  
 * @param pageSize  
 * @return  
 */  
PageResult page(Integer page, Integer pageSize, Integer status);
```

```java
@Override  
public PageResult page(Integer page, Integer pageSize, Integer status) {  
    PageHelper.startPage(page, pageSize);  
    OrdersPageQueryDTO ordersPageQueryDTO = new OrdersPageQueryDTO();  
    ordersPageQueryDTO.setStatus(status);  
    ordersPageQueryDTO.setUserId(BaseContext.getCurrentId());  
  
    //先分页查询订单，要用Page对象  
    Page<Orders> ordersList = orderMapper.pageQuery(ordersPageQueryDTO);  
    List<OrderVO> list = new ArrayList<>();  
  
    //再根据订单来分别查订单明细，并封装入OrderVO进行响应  
    if (ordersList != null && ordersList.getTotal() > 0) {  
        for (Orders orders : ordersList) {  
            OrderVO orderVO = new OrderVO();  
            List<OrderDetail> orderDetailList = orderDetailMapper.getById(orders.getId()); //这里是通过订单id查询  
            BeanUtils.copyProperties(orders, orderVO);  
            orderVO.setOrderDetailList(orderDetailList);  
            list.add(orderVO);  
        }  
    }  
  
    return new PageResult(ordersList.getTotal(), list);  
}
```

OrderMapper：

```java
/**  
 * 查询历史订单  
 * @param ordersPageQueryDTO  
 * @return  
 */  
Page<Orders> pageQuery(OrdersPageQueryDTO ordersPageQueryDTO);
```

```java
<select id="pageQuery" resultType="com.sky.entity.Orders">  
    select * from orders  
    <where>  
        <if test="number != null and number != ''">  
            and number like concat('%',#{number},'%')  
        </if>  
        <if test="phone != null and phone != ''">  
            and number like concat('%',#{phone},'%')  
        </if>  
        <if test="userId != null">  
            and user_id = #{userId}  
        </if>  
        <if test="status != null">  
            and status = #{status}  
        </if>  
        <if test="beginTime != null">  
            and order_time &gt;= #{beginTime}  
        </if>  
        <if test="endTime != null">  
            and order_time &lt;= #{endTime}  
        </if>  
    </where>  
    order by order_time desc  
</select>
```

OrderDetailMapper：

```java
/**  
 * 查询订单明细  
 * @return  
 */  
@Select("select * from order_detail where order_id = #{orderId}")  
List<OrderDetail> getById(Long orderId);
```

### 测试

![[Pasted image 20240528221220.png|298]]