### 需求分析与设计

##### 业务规则：

- 待支付和待接单状态下，用户可直接取消订单
- 商家已接单状态下，用户取消订单需电话沟通商家
- 派送中状态下，用户取消订单需电话沟通商家
- 如果在待接单状态下取消订单，需要给用户退款
- 取消订单后需要将订单状态修改为“已取消”

![[Pasted image 20240529101541.png|350]]

### 易错点

service层判断订单状态，然后像不能退款或者需要电话联系商家的状态直接抛一个异常信息就行。

### 代码开发

OrderController：

```java
@PutMapping("/cancel/{id}")  
@ApiOperation("取消订单")  
public Result cancelOrder(@PathVariable Long id) {  
    log.info("要取消的订单id：{}", id);  
    orderService.cancelOrder(id);  
    return Result.success();  
}
```

OrderService：

```java
/**  
 * 取消订单  
 * @param id  
 */  
void cancelOrder(Long id);
```

```java
@Override  
public void cancelOrder(Long id) {  
    Orders order = orderMapper.getById(id);  
    //订单不存在就返回错误信息  
    if (order == null) {  
        throw new OrderBusinessException(MessageConstant.ORDER_NOT_FOUND);  
    }  
    //订单状态 1待付款 2待接单 3已接单 4派送中 5已完成 6已取消  
    Integer status = order.getStatus();  
    if (status > 4) {  
        throw new OrderBusinessException(MessageConstant.ORDER_STATUS_ERROR);  
    }  
    if (status.equals(Orders.CONFIRMED) || status.equals(Orders.DELIVERY_IN_PROGRESS)) {  
        throw new OrderBusinessException(MessageConstant.ORDER_PHONE);  
    }  
    if (status.equals(Orders.TO_BE_CONFIRMED)) {  
        order.setPayStatus(Orders.REFUND);  
    }  
    // 更新订单状态、取消原因、取消时间  
    order.setStatus(Orders.CANCELLED);  
    order.setCancelReason("用户取消");  
    order.setCancelTime(LocalDateTime.now());  
    orderMapper.update(order);  
}
```

### 测试

![[Pasted image 20240529110440.png|272]]